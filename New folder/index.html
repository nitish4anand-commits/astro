<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Create Kundli - Vedic Astrology App Preview</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; }
  </style>
</head>
<body class="bg-gray-50">
  <nav class="bg-white shadow">
    <div class="max-w-6xl mx-auto px-6 py-4 flex justify-between">
      <h1 class="text-2xl font-bold text-indigo-600">ğŸ”® Astro Kundli</h1>
      <div class="space-x-4">
        <button onclick="showPage('home')" class="text-gray-700 hover:text-indigo-600">Home</button>
        <button onclick="showPage('demo')" class="text-gray-700 hover:text-indigo-600">Demo</button>
        <button onclick="showPage('create')" class="text-indigo-600 font-semibold">Create Kundli</button>
        <button onclick="showPage('kundli')" class="text-gray-700 hover:text-indigo-600">Sample Kundli</button>
      </div>
    </div>
  </nav>

  <main class="max-w-6xl mx-auto p-6">
    <!-- Home Page -->
    <div id="home-page" class="hidden">
      <div class="text-center py-12">
        <h2 class="text-5xl font-bold mb-4">Vedic Astrology, Simplified</h2>
        <p class="text-xl text-gray-600 mb-8">Calculate your kundli (birth chart) and discover insights from Vedic astrology with accuracy and clarity.</p>
        <button onclick="showPage('create')" class="px-8 py-3 bg-indigo-600 text-white rounded-lg font-bold hover:bg-indigo-700">Create Your Kundli</button>
      </div>
    </div>

    <!-- Demo Page -->
    <div id="demo-page" class="hidden">
      <h2 class="text-3xl font-bold mb-6">Demo Kundlis</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="bg-white rounded-lg shadow p-6 cursor-pointer hover:shadow-lg" onclick="showPage('kundli')">
          <h3 class="text-xl font-bold mb-2">Raj Kapoor</h3>
          <p class="text-gray-600 mb-4">Dec 14, 1924 | Peshawar, Pakistan (then India)</p>
          <p class="text-sm text-indigo-600">View Kundli â†’</p>
        </div>
        <div class="bg-white rounded-lg shadow p-6 cursor-pointer hover:shadow-lg" onclick="showPage('kundli')">
          <h3 class="text-xl font-bold mb-2">Indira Gandhi</h3>
          <p class="text-gray-600 mb-4">Nov 19, 1917 | Allahabad, India</p>
          <p class="text-sm text-indigo-600">View Kundli â†’</p>
        </div>
      </div>
    </div>

    <!-- Create Kundli Page -->
    <div id="create-page">
      <form id="kundliForm">
      <!-- Error message (hidden by default) -->
      <div id="errorMsg" class="hidden text-red-600 bg-red-50 p-4 rounded"></div>

      <!-- Name field -->
      <div>
        <label class="block text-sm font-medium text-gray-700">Name *</label>
        <input type="text" name="name" required placeholder="Your full name" class="mt-2 w-full border border-gray-300 rounded px-3 py-2 focus:ring-2 focus:ring-indigo-500">
      </div>

      <!-- Date/Time field -->
      <div>
        <label class="block text-sm font-medium text-gray-700">Date / Time of Birth *</label>
        <input type="datetime-local" name="local_datetime" required class="mt-2 w-full border border-gray-300 rounded px-3 py-2 focus:ring-2 focus:ring-indigo-500">
        <p class="text-sm text-gray-500 mt-1">If you don't know the time, toggle "I don't know birth time" and we'll use noon.</p>
      </div>

      <!-- Place field with autocomplete dropdown -->
      <div>
        <label class="block text-sm font-medium text-gray-700">Place *</label>
        <div class="relative mt-2">
          <input type="text" name="place" placeholder="City, India" required class="w-full border border-gray-300 rounded px-3 py-2 focus:ring-2 focus:ring-indigo-500" id="placeInput">
          <ul id="suggestions" class="absolute mt-1 w-full bg-white border border-gray-300 rounded shadow max-h-56 overflow-auto hidden z-10">
            <li class="px-3 py-2 hover:bg-gray-100 cursor-pointer" onclick="selectPlace('Mumbai, India', 19.076, 72.8777)">ğŸ“ Mumbai, India</li>
            <li class="px-3 py-2 hover:bg-gray-100 cursor-pointer" onclick="selectPlace('Bengaluru, India', 12.9716, 77.5946)">ğŸ“ Bengaluru, India</li>
            <li class="px-3 py-2 hover:bg-gray-100 cursor-pointer" onclick="selectPlace('New Delhi, India', 28.6139, 77.209)">ğŸ“ New Delhi, India</li>
            <li class="px-3 py-2 hover:bg-gray-100 cursor-pointer" onclick="selectPlace('Chennai, India', 13.0827, 80.2707)">ğŸ“ Chennai, India</li>
          </ul>
        </div>
        <p class="text-sm text-gray-500 mt-1">Suggestions from an offline Indian gazetteer.</p>
      </div>

      <!-- Lat/Lon fields -->
      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700">Latitude (optional)</label>
          <input type="number" step="any" name="lat" placeholder="19.076" class="mt-2 w-full border border-gray-300 rounded px-3 py-2 focus:ring-2 focus:ring-indigo-500" id="latInput">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Longitude (optional)</label>
          <input type="number" step="any" name="lon" placeholder="72.8777" class="mt-2 w-full border border-gray-300 rounded px-3 py-2 focus:ring-2 focus:ring-indigo-500" id="lonInput">
        </div>
      </div>

      <!-- Checkbox: Don't know time -->
      <div class="flex items-center gap-3 pt-2">
        <input type="checkbox" name="unknownTime" id="unknownTimeCheckbox" class="w-4 h-4">
        <label for="unknownTimeCheckbox" class="text-sm">I don't know birth time</label>
      </div>

      <!-- Submit button -->
      <div class="flex justify-between items-center pt-4">
        <div></div>
        <button type="submit" id="submitBtn" class="px-6 py-2 bg-indigo-600 text-white rounded font-medium hover:bg-indigo-700 disabled:opacity-50">Create Kundli</button>
      </div>
      </form>

      <!-- Demo result (hidden) -->
      <div id="resultSection" class="mt-8 hidden">
        <div class="bg-green-50 border border-green-200 rounded-lg p-6">
          <h3 class="text-xl font-bold text-green-700 mb-2">âœ… Kundli Created!</h3>
          <p class="text-gray-700">Chart ID: <code id="chartId" class="bg-gray-100 px-2 py-1 rounded">chart-demo-123</code></p>
          <p class="text-gray-700 mt-2">Redirecting to your kundli dashboard...</p>
        </div>
      </div>
    </div>

    <!-- Kundli View Page -->
    <div id="kundli-page" class="hidden">
      <div class="mb-6">
        <button onclick="showPage('create')" class="text-indigo-600 hover:text-indigo-800">â† Back</button>
      </div>
      <h2 class="text-3xl font-bold mb-6">Your Kundli Dashboard</h2>
      
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Chart Info -->
        <div class="lg:col-span-2 bg-white rounded-lg shadow p-8">
          <h3 class="text-2xl font-bold mb-4">Birth Details</h3>
          <div class="grid grid-cols-2 gap-4 text-gray-700">
            <div>
              <p class="text-sm font-semibold text-gray-500">Name</p>
              <p class="text-lg" id="bd-name">Your Name</p>
            </div>
            <div>
              <p class="text-sm font-semibold text-gray-500">Date & Time</p>
              <p class="text-lg" id="bd-datetime">Jan 1, 1990 12:00 PM</p>
            </div>
            <div>
              <p class="text-sm font-semibold text-gray-500">Place</p>
              <p class="text-lg" id="bd-place">Mumbai, India</p>
            </div>
            <div>
              <p class="text-sm font-semibold text-gray-500">Timezone</p>
              <p class="text-lg" id="bd-timezone">Resolved</p>
            </div>
          </div>

          <hr class="my-6">

          <h3 class="text-xl font-bold mb-4">Planets (Sidereal Longitudes)</h3>
          <div class="space-y-3 font-mono text-sm">
            <div id="vedic-planets" class="space-y-2"></div>
          </div>
        </div>

        <!-- Sidebar: Dashas -->
        <div class="bg-indigo-50 rounded-lg shadow p-6">
          <h3 class="text-xl font-bold mb-4">Current Mahadasha</h3>
          <div class="space-y-4">
            <div>
              <p class="text-sm font-semibold text-indigo-700" id="mahadasha-name">â€”</p>
              <p class="text-xs text-gray-600" id="mahadasha-dates">â€”</p>
              <div class="mt-1 w-full bg-gray-300 rounded h-2">
                <div class="bg-indigo-600 h-2 rounded" id="mahadasha-progress" style="width: 0%"></div>
              </div>
              <p class="text-xs text-gray-600 mt-1" id="mahadasha-progress-text">â€”</p>
            </div>

            <hr class="my-4">

            <div>
              <p class="text-sm font-semibold text-indigo-700" id="antardasha-name">â€”</p>
              <p class="text-xs text-gray-600" id="antardasha-dates">â€”</p>
            </div>
          </div>

          <hr class="my-4">

          <h3 class="text-lg font-bold mb-3">Nakshatras</h3>
          <div class="space-y-2 text-sm">
            <div><span class="font-semibold">Moon Nakshatra:</span> Magha</div>
            <div><span class="font-semibold">Birth Nakshatra Pada:</span> 2nd Quarter</div>
          </div>
        </div>
      </div>
    </div>

  <script>
    const NOMINATIM_URL = 'https://nominatim.openstreetmap.org';
    // Optional Google Places fallback (set window.GOOGLE_MAPS_API_KEY at runtime for dev use)
    const GOOGLE_MAPS_API_KEY = (window && window.GOOGLE_MAPS_API_KEY) ? String(window.GOOGLE_MAPS_API_KEY) : '';
    // Page routing
    function showPage(pageName) {
      document.getElementById('home-page').classList.add('hidden');
      document.getElementById('demo-page').classList.add('hidden');
      document.getElementById('create-page').classList.add('hidden');
      document.getElementById('kundli-page').classList.add('hidden');
      
      document.getElementById(pageName + '-page').classList.remove('hidden');
    }

    // Default: show home
    showPage('home');

    const placeInput = document.getElementById('placeInput');
    const suggestions = document.getElementById('suggestions');
    const form = document.getElementById('kundliForm');
    const errorMsg = document.getElementById('errorMsg');
    const resultSection = document.getElementById('resultSection');
    const submitBtn = document.getElementById('submitBtn');
    const bdName = document.getElementById('bd-name');
    const bdDatetime = document.getElementById('bd-datetime');
    const bdPlace = document.getElementById('bd-place');
    const bdTimezone = document.getElementById('bd-timezone');
    const vedicPlanets = document.getElementById('vedic-planets');
    const mahaName = document.getElementById('mahadasha-name');
    const mahaDates = document.getElementById('mahadasha-dates');
    const mahaProgress = document.getElementById('mahadasha-progress');
    const mahaProgressText = document.getElementById('mahadasha-progress-text');
    const antarName = document.getElementById('antardasha-name');
    const antarDates = document.getElementById('antardasha-dates');

    // Fetch Nominatim suggestions, fallback to Google Places if configured
    let debounceTimer;
    placeInput.addEventListener('input', () => {
      clearTimeout(debounceTimer);
      const q = placeInput.value.trim();
      if (!q) { suggestions.classList.add('hidden'); return; }
      debounceTimer = setTimeout(async () => {
        try {
          const url = `${NOMINATIM_URL}/search?q=${encodeURIComponent(q)}&format=jsonv2&addressdetails=1&limit=6`;
          const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
          const data = await res.json();
          suggestions.innerHTML = '';
          data.forEach(item => {
            const li = document.createElement('li');
            li.className = 'px-3 py-2 hover:bg-gray-100 cursor-pointer';
            li.textContent = `ğŸ“ ${item.display_name}`;
            li.onclick = () => selectPlace(item.display_name, item.lat, item.lon);
            suggestions.appendChild(li);
          });
          if (data.length === 0 && GOOGLE_MAPS_API_KEY) {
            // Fallback: Google Places Autocomplete (REST). Note: May require proxy for CORS in production.
            try {
              const gpUrl = `https://maps.googleapis.com/maps/api/place/autocomplete/json?input=${encodeURIComponent(q)}&types=(cities)&key=${GOOGLE_MAPS_API_KEY}`;
              const gpRes = await fetch(gpUrl);
              const gpData = await gpRes.json();
              if (Array.isArray(gpData.predictions)) {
                for (const p of gpData.predictions.slice(0, 6)) {
                  const li = document.createElement('li');
                  li.className = 'px-3 py-2 hover:bg-gray-100 cursor-pointer';
                  li.textContent = `ğŸ“ ${p.description}`;
                  // Without place details, we cannot resolve lat/lon here; allow selection for name only
                  li.onclick = () => selectPlace(p.description, '', '');
                  suggestions.appendChild(li);
                }
              }
            } catch (gErr) {
              console.warn('Google Places fallback error', gErr);
            }
          }
          suggestions.classList.remove('hidden');
        } catch (err) {
          console.warn('Nominatim error', err);
          // Attempt Google fallback if Nominatim fails
          if (GOOGLE_MAPS_API_KEY) {
            try {
              const gpUrl = `https://maps.googleapis.com/maps/api/place/autocomplete/json?input=${encodeURIComponent(q)}&types=(cities)&key=${GOOGLE_MAPS_API_KEY}`;
              const gpRes = await fetch(gpUrl);
              const gpData = await gpRes.json();
              suggestions.innerHTML = '';
              if (Array.isArray(gpData.predictions)) {
                for (const p of gpData.predictions.slice(0, 6)) {
                  const li = document.createElement('li');
                  li.className = 'px-3 py-2 hover:bg-gray-100 cursor-pointer';
                  li.textContent = `ğŸ“ ${p.description}`;
                  li.onclick = () => selectPlace(p.description, '', '');
                  suggestions.appendChild(li);
                }
              }
              suggestions.classList.remove('hidden');
            } catch (gErr) {
              console.warn('Google Places fallback error', gErr);
            }
          }
        }
      }, 250);
    });

    placeInput.addEventListener('blur', () => {
      setTimeout(() => suggestions.classList.add('hidden'), 200);
    });

    function selectPlace(name, lat, lon) {
      placeInput.value = name;
      document.getElementById('latInput').value = lat;
      document.getElementById('lonInput').value = lon;
      suggestions.classList.add('hidden');
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      errorMsg.classList.add('hidden');
      submitBtn.disabled = true;
      submitBtn.textContent = 'Creatingâ€¦';

      try {
        const name = document.querySelector('input[name="name"]').value.trim();
        const dtInput = document.querySelector('input[name="local_datetime"]').value;
        const place = document.querySelector('input[name="place"]').value.trim();
        const latVal = document.getElementById('latInput').value;
        const lonVal = document.getElementById('lonInput').value;
        const unknownTime = document.getElementById('unknownTimeCheckbox').checked;

        if (!name || !dtInput || !place) throw new Error('Please fill all required fields.');

        // Handle unknown time by forcing noon
        let localDatetime = dtInput;
        if (unknownTime) {
          const [datePart] = dtInput.split('T');
          localDatetime = `${datePart}T12:00`;
        }

        const payload = {
          name,
          local_datetime: localDatetime,
          place,
          lat: latVal ? parseFloat(latVal) : null,
          lon: lonVal ? parseFloat(lonVal) : null,
          unknown_time: unknownTime
        };

        // Call chart API
        const apiBase = 'http://localhost:8000';
        const chartRes = await fetch(`${apiBase}/v1/chart`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        if (!chartRes.ok) throw new Error(`Chart API error: ${chartRes.status}`);
        const chart = await chartRes.json();
        window.chartData = chart;

        // Update dashboard basics
        bdName.textContent = chart.input_echo.name;
        const dt = new Date(chart.astronomy.utc_datetime);
        bdDatetime.textContent = dt.toUTCString();
        bdPlace.textContent = chart.input_echo.place;
        bdTimezone.textContent = 'Resolved';

        // Populate Vedic planets (top 6)
        vedicPlanets.innerHTML = '';
        (chart.vedic.planets || []).slice(0, 6).forEach(p => {
          const row = document.createElement('div');
          row.className = 'flex justify-between';
          const left = document.createElement('span');
          left.textContent = String(p.name || '');
          const right = document.createElement('span');
          right.className = 'text-indigo-600';
          right.textContent = `${p.degree}Â° ${p.rashi}`;
          row.appendChild(left);
          row.appendChild(right);
          vedicPlanets.appendChild(row);
        });

        // Fetch dashas
        try {
          const dashaRes = await fetch(`${apiBase}/v1/dasha/vimshottari`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          if (dashaRes.ok) {
            const dj = await dashaRes.json();
            const maha = dj.dashas.find(d => d.level === 'Maha' && d.current);
            const antar = dj.dashas.find(d => d.level === 'Antar' && d.current);
            if (maha) {
              mahaName.textContent = `${maha.planet} Mahadasha`;
              const sd = new Date(maha.start_date), ed = new Date(maha.end_date);
              mahaDates.textContent = `${sd.getFullYear()} - ${ed.getFullYear()}`;
              const total = ed - sd; const elapsed = Date.now() - sd.getTime();
              const pct = Math.max(0, Math.min(100, Math.round((elapsed/total)*100)));
              mahaProgress.style.width = pct + '%';
              mahaProgressText.textContent = `${pct}% Complete`;
            }
            if (antar) {
              antarName.textContent = `${antar.planet} Antardasha (Current)`;
              const sd = new Date(antar.start_date), ed = new Date(antar.end_date);
              antarDates.textContent = `${sd.getFullYear()} - ${ed.getFullYear()}`;
            }
          }
        } catch (e2) { console.warn('Dasha fetch failed', e2); }

        // Success
        resultSection.classList.remove('hidden');
        document.getElementById('chartId').textContent = chart.chart_id || ('chart-' + Math.random().toString(36).substr(2, 9));
        setTimeout(() => showPage('kundli'), 1200);
      } catch (err) {
        console.error(err);
        errorMsg.textContent = err.message || 'Failed to create chart.';
        errorMsg.classList.remove('hidden');
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Create Kundli';
      }
    });
  </script>
</body>
</html>
